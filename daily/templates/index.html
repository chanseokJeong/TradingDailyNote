<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily Notes - ì£¼ì‹ ì¼ì§€</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <!-- ë‚ ì§œ í—¤ë” -->
        <header class="date-header">
            <button id="prevDay" class="nav-btn">&larr;</button>
            <div class="date-display">
                <span id="dateIcon">ğŸ“…</span>
                <input type="date" id="noteDate" value="{{ today }}">
                <span id="todayBadge" class="today-badge">ì˜¤ëŠ˜</span>
            </div>
            <button id="nextDay" class="nav-btn">&rarr;</button>
        </header>

        <!-- ì´ë¯¸ì§€ ë“œë¡­ ì˜ì—­ -->
        <section class="drop-zone" id="dropZone">
            <div class="drop-placeholder" id="dropPlaceholder">
                <span class="drop-icon">ğŸ“·</span>
                <p>ì´ë¯¸ì§€ë¥¼ ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•˜ì„¸ìš”</p>
                <p class="drop-hint">Ctrl+Vë¡œ ë¶™ì—¬ë„£ê¸°ë„ ê°€ëŠ¥í•©ë‹ˆë‹¤</p>
            </div>
            <div class="image-preview" id="imagePreview"></div>
            <input type="file" id="fileInput" accept="image/*" multiple hidden>
        </section>

        <!-- ë©”ëª¨ ì˜ì—­ -->
        <section class="note-section">
            <label for="noteContent">ì˜¤ëŠ˜ì˜ ë©”ëª¨:</label>
            <textarea
                id="noteContent"
                placeholder="ë°˜ë„ì²´ í…Œë§ˆ ê°•ì„¸, ì¢…ê°€ë² íŒ… ê³ ë ¤..."
                rows="3"
            ></textarea>
            <div class="tags-display" id="tagsDisplay"></div>
            <input
                type="text"
                id="tagInput"
                placeholder="íƒœê·¸ ì…ë ¥ í›„ Enter (ì˜ˆ: #ë°˜ë„ì²´)"
                class="tag-input"
            >
        </section>

        <!-- ì €ì¥ ë²„íŠ¼ -->
        <button id="saveBtn" class="save-btn">
            <span class="save-icon">ğŸ’¾</span> ì €ì¥
        </button>

        <!-- ìƒíƒœ ë©”ì‹œì§€ -->
        <div id="statusMessage" class="status-message"></div>

        <!-- ìµœê·¼ ë…¸íŠ¸ ëª©ë¡ -->
        <section class="recent-notes">
            <h3>ğŸ“‹ ìµœê·¼ ë…¸íŠ¸</h3>
            <div id="recentList"></div>
        </section>
    </div>

    <script>
        // ìƒíƒœ
        let currentDate = '{{ today }}';
        let uploadedImages = [];
        let tags = [];

        // DOM ìš”ì†Œ
        const dateInput = document.getElementById('noteDate');
        const dropZone = document.getElementById('dropZone');
        const dropPlaceholder = document.getElementById('dropPlaceholder');
        const imagePreview = document.getElementById('imagePreview');
        const fileInput = document.getElementById('fileInput');
        const noteContent = document.getElementById('noteContent');
        const tagInput = document.getElementById('tagInput');
        const tagsDisplay = document.getElementById('tagsDisplay');
        const saveBtn = document.getElementById('saveBtn');
        const statusMessage = document.getElementById('statusMessage');
        const todayBadge = document.getElementById('todayBadge');
        const recentList = document.getElementById('recentList');

        // ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', () => {
            loadNote(currentDate);
            loadRecentNotes();
            updateTodayBadge();
        });

        // ë‚ ì§œ ë³€ê²½
        dateInput.addEventListener('change', (e) => {
            currentDate = e.target.value;
            loadNote(currentDate);
            updateTodayBadge();
        });

        // ì´ì „/ë‹¤ìŒ ë‚ 
        document.getElementById('prevDay').addEventListener('click', () => {
            const d = new Date(currentDate);
            d.setDate(d.getDate() - 1);
            currentDate = d.toISOString().split('T')[0];
            dateInput.value = currentDate;
            loadNote(currentDate);
            updateTodayBadge();
        });

        document.getElementById('nextDay').addEventListener('click', () => {
            const d = new Date(currentDate);
            d.setDate(d.getDate() + 1);
            currentDate = d.toISOString().split('T')[0];
            dateInput.value = currentDate;
            loadNote(currentDate);
            updateTodayBadge();
        });

        function updateTodayBadge() {
            const today = new Date().toISOString().split('T')[0];
            todayBadge.style.display = (currentDate === today) ? 'inline' : 'none';
        }

        // ë“œë˜ê·¸ì•¤ë“œë¡­
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('drag-over');
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('drag-over');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('drag-over');
            handleFiles(e.dataTransfer.files);
        });

        // í´ë¦­í•´ì„œ íŒŒì¼ ì„ íƒ
        dropZone.addEventListener('click', () => {
            fileInput.click();
        });

        fileInput.addEventListener('change', (e) => {
            handleFiles(e.target.files);
        });

        // ë¶™ì—¬ë„£ê¸° (Ctrl+V)
        document.addEventListener('paste', (e) => {
            const items = e.clipboardData.items;
            for (let item of items) {
                if (item.type.indexOf('image') !== -1) {
                    const file = item.getAsFile();
                    handleFiles([file]);
                    break;
                }
            }
        });

        // íŒŒì¼ ì²˜ë¦¬ ë° ì—…ë¡œë“œ
        async function handleFiles(files) {
            for (let file of files) {
                if (!file.type.startsWith('image/')) continue;

                showStatus('ì´ë¯¸ì§€ ì—…ë¡œë“œ ì¤‘...', 'loading');

                const formData = new FormData();
                formData.append('file', file);

                try {
                    const res = await fetch('/api/upload', {
                        method: 'POST',
                        body: formData
                    });
                    const data = await res.json();

                    if (data.success) {
                        uploadedImages.push(data.url);
                        renderImages();
                        showStatus('ì´ë¯¸ì§€ ì—…ë¡œë“œ ì™„ë£Œ!', 'success');
                    } else {
                        showStatus('ì—…ë¡œë“œ ì‹¤íŒ¨: ' + data.error, 'error');
                    }
                } catch (err) {
                    showStatus('ì—…ë¡œë“œ ì˜¤ë¥˜: ' + err.message, 'error');
                }
            }
        }

        // ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° ë Œë”ë§
        function renderImages() {
            if (uploadedImages.length === 0) {
                dropPlaceholder.style.display = 'block';
                imagePreview.innerHTML = '';
                return;
            }

            dropPlaceholder.style.display = 'none';
            imagePreview.innerHTML = uploadedImages.map((url, idx) => `
                <div class="image-item">
                    <img src="${url}" alt="Image ${idx + 1}">
                    <button class="remove-btn" onclick="removeImage(${idx})">&times;</button>
                </div>
            `).join('');
        }

        // ì´ë¯¸ì§€ ì œê±°
        window.removeImage = function(idx) {
            uploadedImages.splice(idx, 1);
            renderImages();
        };

        // íƒœê·¸ ì…ë ¥
        tagInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                let tag = tagInput.value.trim();
                if (!tag) return;

                // # ìë™ ì¶”ê°€
                if (!tag.startsWith('#')) {
                    tag = '#' + tag;
                }

                if (!tags.includes(tag)) {
                    tags.push(tag);
                    renderTags();
                }
                tagInput.value = '';
            }
        });

        // íƒœê·¸ ë Œë”ë§
        function renderTags() {
            tagsDisplay.innerHTML = tags.map((tag, idx) => `
                <span class="tag">
                    ${tag}
                    <button onclick="removeTag(${idx})">&times;</button>
                </span>
            `).join('');
        }

        // íƒœê·¸ ì œê±°
        window.removeTag = function(idx) {
            tags.splice(idx, 1);
            renderTags();
        };

        // ë…¸íŠ¸ ë¡œë“œ
        async function loadNote(noteDate) {
            try {
                const res = await fetch(`/api/note/${noteDate}`);
                const data = await res.json();

                if (data.success && data.note) {
                    noteContent.value = data.note.content || '';
                    tags = data.note.tags || [];
                    uploadedImages = data.note.image_urls || [];
                    renderTags();
                    renderImages();
                } else {
                    // í•´ë‹¹ ë‚ ì§œ ë…¸íŠ¸ ì—†ìŒ - ì´ˆê¸°í™”
                    noteContent.value = '';
                    tags = [];
                    uploadedImages = [];
                    renderTags();
                    renderImages();
                }
            } catch (err) {
                showStatus('ë¡œë“œ ì˜¤ë¥˜: ' + err.message, 'error');
            }
        }

        // ë…¸íŠ¸ ì €ì¥
        saveBtn.addEventListener('click', async () => {
            const payload = {
                note_date: currentDate,
                content: noteContent.value,
                tags: tags,
                image_urls: uploadedImages
            };

            showStatus('ì €ì¥ ì¤‘...', 'loading');

            try {
                const res = await fetch('/api/note', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const data = await res.json();

                if (data.success) {
                    showStatus('ì €ì¥ ì™„ë£Œ!', 'success');
                    loadRecentNotes();
                } else {
                    showStatus('ì €ì¥ ì‹¤íŒ¨: ' + data.error, 'error');
                }
            } catch (err) {
                showStatus('ì €ì¥ ì˜¤ë¥˜: ' + err.message, 'error');
            }
        });

        // ìƒíƒœ ë©”ì‹œì§€ í‘œì‹œ
        function showStatus(msg, type) {
            statusMessage.textContent = msg;
            statusMessage.className = 'status-message ' + type;
            statusMessage.style.display = 'block';

            if (type !== 'loading') {
                setTimeout(() => {
                    statusMessage.style.display = 'none';
                }, 3000);
            }
        }

        // ìµœê·¼ ë…¸íŠ¸ ëª©ë¡ ë¡œë“œ
        async function loadRecentNotes() {
            try {
                const res = await fetch('/api/notes?limit=10');
                const data = await res.json();

                if (data.success && data.notes.length > 0) {
                    recentList.innerHTML = data.notes.map(note => `
                        <div class="recent-item" onclick="goToDate('${note.note_date}')">
                            <span class="recent-date">${note.note_date}</span>
                            <span class="recent-content">${(note.content || '').substring(0, 50)}${(note.content || '').length > 50 ? '...' : ''}</span>
                            ${note.tags && note.tags.length > 0 ? `<span class="recent-tags">${note.tags.join(' ')}</span>` : ''}
                        </div>
                    `).join('');
                } else {
                    recentList.innerHTML = '<p class="no-notes">ì•„ì§ ë…¸íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                }
            } catch (err) {
                console.error('ìµœê·¼ ë…¸íŠ¸ ë¡œë“œ ì˜¤ë¥˜:', err);
            }
        }

        // íŠ¹ì • ë‚ ì§œë¡œ ì´ë™
        window.goToDate = function(noteDate) {
            currentDate = noteDate;
            dateInput.value = noteDate;
            loadNote(noteDate);
            updateTodayBadge();
        };
    </script>
</body>
</html>
