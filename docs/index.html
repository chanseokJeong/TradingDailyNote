<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily Notes - ì£¼ì‹ ì¼ì§€</title>
    <link rel="stylesheet" href="style.css">
    <!-- Supabase JS Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <!-- ì„¤ì • ëª¨ë‹¬ -->
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <h2>Supabase ì„¤ì •</h2>
            <p>Supabase í”„ë¡œì íŠ¸ ì •ë³´ë¥¼ ì…ë ¥í•˜ì„¸ìš”.</p>
            <input type="text" id="supabaseUrl" placeholder="https://xxxxx.supabase.co">
            <input type="password" id="supabaseKey" placeholder="anon key">
            <button id="saveSettings" class="save-btn">ì €ì¥ ë° ì—°ê²°</button>
            <p class="hint">ì„¤ì •ì€ ë¸Œë¼ìš°ì €ì— ì €ì¥ë©ë‹ˆë‹¤.</p>
        </div>
    </div>

    <div class="container">
        <!-- í—¤ë” -->
        <div class="top-bar">
            <h1 class="app-title">Daily Notes</h1>
            <button id="settingsBtn" class="settings-btn" title="ì„¤ì •">âš™ï¸</button>
        </div>

        <!-- ë‚ ì§œ í—¤ë” -->
        <header class="date-header">
            <button id="prevDay" class="nav-btn">&larr;</button>
            <div class="date-display">
                <span id="dateIcon">ğŸ“…</span>
                <input type="date" id="noteDate">
                <span id="todayBadge" class="today-badge">ì˜¤ëŠ˜</span>
            </div>
            <button id="nextDay" class="nav-btn">&rarr;</button>
        </header>

        <!-- ì´ë¯¸ì§€ ë“œë¡­ ì˜ì—­ -->
        <section class="drop-zone" id="dropZone">
            <div class="drop-placeholder" id="dropPlaceholder">
                <span class="drop-icon">ğŸ“·</span>
                <p>ì´ë¯¸ì§€ë¥¼ ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•˜ì„¸ìš”</p>
                <p class="drop-hint">Ctrl+V ë¶™ì—¬ë„£ê¸° ê°€ëŠ¥ | ì—¬ëŸ¬ ì¥ ì—…ë¡œë“œ ê°€ëŠ¥</p>
                <p class="drop-limit">ìµœëŒ€ 5MB (ì´ˆê³¼ ì‹œ ìë™ ì••ì¶•)</p>
            </div>
            <div class="image-preview" id="imagePreview"></div>
            <input type="file" id="fileInput" accept="image/*" multiple hidden>
        </section>

        <!-- ë©”ëª¨ ì˜ì—­ -->
        <section class="note-section">
            <label for="noteContent">ì˜¤ëŠ˜ì˜ ë©”ëª¨:</label>
            <textarea
                id="noteContent"
                placeholder="ë°˜ë„ì²´ í…Œë§ˆ ê°•ì„¸, ì¢…ê°€ë² íŒ… ê³ ë ¤..."
                rows="3"
            ></textarea>
            <div class="tags-display" id="tagsDisplay"></div>
            <input
                type="text"
                id="tagInput"
                placeholder="íƒœê·¸ ì…ë ¥ í›„ Enter (ì˜ˆ: #ë°˜ë„ì²´)"
                class="tag-input"
            >
        </section>

        <!-- ë²„íŠ¼ ì˜ì—­ -->
        <div class="button-group">
            <button id="saveBtn" class="save-btn">
                <span class="save-icon">ğŸ’¾</span> ì €ì¥
            </button>
            <button id="deleteBtn" class="delete-btn" style="display: none;">
                <span>ğŸ—‘ï¸</span> ì‚­ì œ
            </button>
        </div>

        <!-- ìƒíƒœ ë©”ì‹œì§€ -->
        <div id="statusMessage" class="status-message"></div>

        <!-- ìµœê·¼ ë…¸íŠ¸ ëª©ë¡ -->
        <section class="recent-notes">
            <div class="recent-header">
                <h3>ğŸ“‹ ìµœê·¼ ë…¸íŠ¸</h3>
                <span id="filterTag" class="filter-tag" style="display: none;">
                    <span id="filterTagName"></span>
                    <button onclick="clearTagFilter()">&times;</button>
                </span>
            </div>
            <div id="recentList"></div>
        </section>

        <!-- ë‚´ë³´ë‚´ê¸° ì„¹ì…˜ -->
        <section class="export-section">
            <h3>ğŸ“¤ ë‚´ë³´ë‚´ê¸° (Export)</h3>
            <div class="export-controls">
                <div class="date-range">
                    <label>ì‹œì‘ì¼</label>
                    <input type="date" id="exportStartDate">
                </div>
                <div class="date-range">
                    <label>ì¢…ë£Œì¼</label>
                    <input type="date" id="exportEndDate">
                </div>
            </div>
            <div class="export-buttons">
                <button id="exportCsv" class="export-btn csv">ğŸ“Š CSV (ì—‘ì…€)</button>
                <button id="exportJson" class="export-btn json">ğŸ“‹ JSON</button>
            </div>
        </section>
    </div>

    <script>
        // Supabase í´ë¼ì´ì–¸íŠ¸
        let supabaseClient = null;
        const BUCKET_NAME = 'trade-images';

        // ìƒíƒœ
        let currentDate = new Date().toISOString().split('T')[0];
        let uploadedImages = [];
        let tags = [];
        let currentNoteId = null;

        // DOM ìš”ì†Œ
        const settingsModal = document.getElementById('settingsModal');
        const settingsBtn = document.getElementById('settingsBtn');
        const supabaseUrlInput = document.getElementById('supabaseUrl');
        const supabaseKeyInput = document.getElementById('supabaseKey');
        const saveSettingsBtn = document.getElementById('saveSettings');

        const dateInput = document.getElementById('noteDate');
        const dropZone = document.getElementById('dropZone');
        const dropPlaceholder = document.getElementById('dropPlaceholder');
        const imagePreview = document.getElementById('imagePreview');
        const fileInput = document.getElementById('fileInput');
        const noteContent = document.getElementById('noteContent');
        const tagInput = document.getElementById('tagInput');
        const tagsDisplay = document.getElementById('tagsDisplay');
        const saveBtn = document.getElementById('saveBtn');
        const deleteBtn = document.getElementById('deleteBtn');
        const statusMessage = document.getElementById('statusMessage');
        const todayBadge = document.getElementById('todayBadge');
        const recentList = document.getElementById('recentList');

        // ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', () => {
            dateInput.value = currentDate;
            loadSettings();
            updateTodayBadge();
        });

        // ì„¤ì • ê´€ë¦¬
        function loadSettings() {
            const url = localStorage.getItem('supabase_url');
            const key = localStorage.getItem('supabase_key');

            if (url && key) {
                supabaseUrlInput.value = url;
                supabaseKeyInput.value = key;
                initSupabase(url, key);
            } else {
                settingsModal.style.display = 'flex';
            }
        }

        function initSupabase(url, key) {
            try {
                supabaseClient = window.supabase.createClient(url, key);
                settingsModal.style.display = 'none';
                loadNote(currentDate);
                loadRecentNotes();
                showStatus('ì—°ê²°ë¨', 'success');
            } catch (err) {
                showStatus('ì—°ê²° ì‹¤íŒ¨: ' + err.message, 'error');
                settingsModal.style.display = 'flex';
            }
        }

        settingsBtn.addEventListener('click', () => {
            settingsModal.style.display = 'flex';
        });

        saveSettingsBtn.addEventListener('click', () => {
            const url = supabaseUrlInput.value.trim();
            const key = supabaseKeyInput.value.trim();

            if (!url || !key) {
                alert('URLê³¼ Keyë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            localStorage.setItem('supabase_url', url);
            localStorage.setItem('supabase_key', key);
            initSupabase(url, key);
        });

        // ëª¨ë‹¬ ë°”ê¹¥ í´ë¦­ ì‹œ ë‹«ê¸°
        settingsModal.addEventListener('click', (e) => {
            if (e.target === settingsModal && supabaseClient) {
                settingsModal.style.display = 'none';
            }
        });

        // ë‚ ì§œ ë³€ê²½
        dateInput.addEventListener('change', (e) => {
            currentDate = e.target.value;
            loadNote(currentDate);
            updateTodayBadge();
        });

        document.getElementById('prevDay').addEventListener('click', () => {
            const d = new Date(currentDate);
            d.setDate(d.getDate() - 1);
            currentDate = d.toISOString().split('T')[0];
            dateInput.value = currentDate;
            loadNote(currentDate);
            updateTodayBadge();
        });

        document.getElementById('nextDay').addEventListener('click', () => {
            const d = new Date(currentDate);
            d.setDate(d.getDate() + 1);
            currentDate = d.toISOString().split('T')[0];
            dateInput.value = currentDate;
            loadNote(currentDate);
            updateTodayBadge();
        });

        function updateTodayBadge() {
            const today = new Date().toISOString().split('T')[0];
            todayBadge.style.display = (currentDate === today) ? 'inline' : 'none';
        }

        // ë“œë˜ê·¸ì•¤ë“œë¡­
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('drag-over');
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('drag-over');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('drag-over');
            handleFiles(e.dataTransfer.files);
        });

        dropZone.addEventListener('click', () => {
            fileInput.click();
        });

        fileInput.addEventListener('change', (e) => {
            handleFiles(e.target.files);
        });

        // ë¶™ì—¬ë„£ê¸° (Ctrl+V)
        document.addEventListener('paste', (e) => {
            const items = e.clipboardData.items;
            for (let item of items) {
                if (item.type.indexOf('image') !== -1) {
                    const file = item.getAsFile();
                    handleFiles([file]);
                    break;
                }
            }
        });

        // í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤
        document.addEventListener('keydown', (e) => {
            // Ctrl+S: ì €ì¥
            if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                saveBtn.click();
            }
            // Ctrl+â†: ì´ì „ ë‚ ì§œ
            if (e.ctrlKey && e.key === 'ArrowLeft') {
                e.preventDefault();
                document.getElementById('prevDay').click();
            }
            // Ctrl+â†’: ë‹¤ìŒ ë‚ ì§œ
            if (e.ctrlKey && e.key === 'ArrowRight') {
                e.preventDefault();
                document.getElementById('nextDay').click();
            }
        });

        // ì´ë¯¸ì§€ ì••ì¶• í•¨ìˆ˜
        const MAX_FILE_SIZE = 5 * 1024 * 1024; // 5MB
        const MAX_WIDTH = 1920;
        const MAX_HEIGHT = 1080;
        const COMPRESSION_QUALITY = 0.8;

        async function compressImage(file) {
            return new Promise((resolve) => {
                // 5MB ì´í•˜ë©´ ê·¸ëŒ€ë¡œ ë°˜í™˜
                if (file.size <= MAX_FILE_SIZE) {
                    resolve(file);
                    return;
                }

                const img = new Image();
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');

                img.onload = () => {
                    let { width, height } = img;

                    // ë¹„ìœ¨ ìœ ì§€í•˜ë©´ì„œ ë¦¬ì‚¬ì´ì¦ˆ
                    if (width > MAX_WIDTH) {
                        height = (height * MAX_WIDTH) / width;
                        width = MAX_WIDTH;
                    }
                    if (height > MAX_HEIGHT) {
                        width = (width * MAX_HEIGHT) / height;
                        height = MAX_HEIGHT;
                    }

                    canvas.width = width;
                    canvas.height = height;
                    ctx.drawImage(img, 0, 0, width, height);

                    canvas.toBlob((blob) => {
                        const compressedFile = new File([blob], file.name, {
                            type: 'image/jpeg',
                            lastModified: Date.now()
                        });
                        resolve(compressedFile);
                    }, 'image/jpeg', COMPRESSION_QUALITY);
                };

                img.src = URL.createObjectURL(file);
            });
        }

        // íŒŒì¼ ì²˜ë¦¬ ë° ì—…ë¡œë“œ
        async function handleFiles(files) {
            if (!supabaseClient) {
                showStatus('Supabase ì—°ê²°ì´ í•„ìš”í•©ë‹ˆë‹¤.', 'error');
                return;
            }

            for (let file of files) {
                if (!file.type.startsWith('image/')) continue;

                const originalSize = (file.size / 1024 / 1024).toFixed(2);

                // 5MB ì´ˆê³¼ ì‹œ ì••ì¶•
                if (file.size > MAX_FILE_SIZE) {
                    showStatus(`ì´ë¯¸ì§€ ì••ì¶• ì¤‘... (${originalSize}MB)`, 'loading');
                    file = await compressImage(file);
                }

                showStatus('ì´ë¯¸ì§€ ì—…ë¡œë“œ ì¤‘...', 'loading');

                try {
                    // ê³ ìœ  íŒŒì¼ëª… ìƒì„±
                    const ext = file.type === 'image/jpeg' ? 'jpg' : (file.name.split('.').pop() || 'png');
                    const uniqueName = `${Date.now()}_${Math.random().toString(36).substr(2, 8)}.${ext}`;

                    // Supabase Storageì— ì—…ë¡œë“œ
                    const { data, error } = await supabaseClient.storage
                        .from(BUCKET_NAME)
                        .upload(uniqueName, file, {
                            contentType: file.type
                        });

                    if (error) throw error;

                    // ê³µê°œ URL ê°€ì ¸ì˜¤ê¸°
                    const { data: urlData } = supabaseClient.storage
                        .from(BUCKET_NAME)
                        .getPublicUrl(uniqueName);

                    uploadedImages.push(urlData.publicUrl);
                    renderImages();
                    showStatus('ì´ë¯¸ì§€ ì—…ë¡œë“œ ì™„ë£Œ!', 'success');
                } catch (err) {
                    showStatus('ì—…ë¡œë“œ ì‹¤íŒ¨: ' + err.message, 'error');
                }
            }
        }

        // ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° ë Œë”ë§
        function renderImages() {
            if (uploadedImages.length === 0) {
                dropPlaceholder.style.display = 'block';
                imagePreview.innerHTML = '';
                return;
            }

            dropPlaceholder.style.display = 'none';
            imagePreview.innerHTML = uploadedImages.map((url, idx) => `
                <div class="image-item">
                    <img src="${url}" alt="Image ${idx + 1}" onclick="openImage('${url}')">
                    <button class="remove-btn" onclick="event.stopPropagation(); removeImage(${idx})">&times;</button>
                </div>
            `).join('');
        }

        window.openImage = function(url) {
            window.open(url, '_blank');
        };

        window.removeImage = function(idx) {
            uploadedImages.splice(idx, 1);
            renderImages();
        };

        // íƒœê·¸ ì…ë ¥
        tagInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                let tag = tagInput.value.trim();
                if (!tag) return;

                if (!tag.startsWith('#')) {
                    tag = '#' + tag;
                }

                if (!tags.includes(tag)) {
                    tags.push(tag);
                    renderTags();
                }
                tagInput.value = '';
            }
        });

        function renderTags() {
            tagsDisplay.innerHTML = tags.map((tag, idx) => `
                <span class="tag">
                    ${tag}
                    <button onclick="removeTag(${idx})">&times;</button>
                </span>
            `).join('');
        }

        window.removeTag = function(idx) {
            tags.splice(idx, 1);
            renderTags();
        };

        // ë…¸íŠ¸ ë¡œë“œ
        async function loadNote(noteDate) {
            if (!supabaseClient) return;

            try {
                const { data, error } = await supabaseClient
                    .from('daily_notes')
                    .select('*')
                    .eq('note_date', noteDate)
                    .single();

                if (error && error.code !== 'PGRST116') {
                    throw error;
                }

                if (data) {
                    currentNoteId = data.id;
                    noteContent.value = data.content || '';
                    tags = data.tags || [];
                    uploadedImages = data.image_urls || [];
                    deleteBtn.style.display = 'flex';
                } else {
                    currentNoteId = null;
                    noteContent.value = '';
                    tags = [];
                    uploadedImages = [];
                    deleteBtn.style.display = 'none';
                }
                renderTags();
                renderImages();
            } catch (err) {
                showStatus('ë¡œë“œ ì˜¤ë¥˜: ' + err.message, 'error');
            }
        }

        // ë…¸íŠ¸ ì €ì¥
        saveBtn.addEventListener('click', async () => {
            if (!supabaseClient) {
                showStatus('Supabase ì—°ê²°ì´ í•„ìš”í•©ë‹ˆë‹¤.', 'error');
                return;
            }

            const payload = {
                note_date: currentDate,
                content: noteContent.value,
                tags: tags,
                image_urls: uploadedImages
            };

            showStatus('ì €ì¥ ì¤‘...', 'loading');

            try {
                let result;
                if (currentNoteId) {
                    // ì—…ë°ì´íŠ¸
                    const { data, error } = await supabaseClient
                        .from('daily_notes')
                        .update(payload)
                        .eq('id', currentNoteId)
                        .select()
                        .single();
                    if (error) throw error;
                    result = data;
                } else {
                    // ìƒˆë¡œ ìƒì„±
                    const { data, error } = await supabaseClient
                        .from('daily_notes')
                        .insert(payload)
                        .select()
                        .single();
                    if (error) throw error;
                    result = data;
                    currentNoteId = result.id;
                }

                showStatus('ì €ì¥ ì™„ë£Œ!', 'success');
                deleteBtn.style.display = 'flex';
                loadRecentNotes();
            } catch (err) {
                showStatus('ì €ì¥ ì‹¤íŒ¨: ' + err.message, 'error');
            }
        });

        // ë…¸íŠ¸ ì‚­ì œ
        deleteBtn.addEventListener('click', async () => {
            if (!supabaseClient || !currentNoteId) {
                showStatus('ì‚­ì œí•  ë…¸íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.', 'error');
                return;
            }

            if (!confirm('ì´ ë…¸íŠ¸ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                return;
            }

            showStatus('ì‚­ì œ ì¤‘...', 'loading');

            try {
                const { error } = await supabaseClient
                    .from('daily_notes')
                    .delete()
                    .eq('id', currentNoteId);

                if (error) throw error;

                // ìƒíƒœ ì´ˆê¸°í™”
                currentNoteId = null;
                noteContent.value = '';
                tags = [];
                uploadedImages = [];
                renderTags();
                renderImages();
                deleteBtn.style.display = 'none';

                showStatus('ì‚­ì œ ì™„ë£Œ!', 'success');
                loadRecentNotes();
            } catch (err) {
                showStatus('ì‚­ì œ ì‹¤íŒ¨: ' + err.message, 'error');
            }
        });

        // ìƒíƒœ ë©”ì‹œì§€ í‘œì‹œ
        function showStatus(msg, type) {
            statusMessage.textContent = msg;
            statusMessage.className = 'status-message ' + type;
            statusMessage.style.display = 'block';

            if (type !== 'loading') {
                setTimeout(() => {
                    statusMessage.style.display = 'none';
                }, 3000);
            }
        }

        // íƒœê·¸ í•„í„° ìƒíƒœ
        let currentFilterTag = null;
        const filterTagEl = document.getElementById('filterTag');
        const filterTagName = document.getElementById('filterTagName');

        // ìµœê·¼ ë…¸íŠ¸ ëª©ë¡ ë¡œë“œ
        async function loadRecentNotes(filterTag = null) {
            if (!supabaseClient) return;

            try {
                let query = supabaseClient
                    .from('daily_notes')
                    .select('*')
                    .order('note_date', { ascending: false })
                    .limit(20);

                // íƒœê·¸ í•„í„° ì ìš©
                if (filterTag) {
                    query = query.contains('tags', [filterTag]);
                }

                const { data, error } = await query;

                if (error) throw error;

                if (data && data.length > 0) {
                    recentList.innerHTML = data.map(note => `
                        <div class="recent-item">
                            <span class="recent-date" onclick="goToDate('${note.note_date}')">${note.note_date}</span>
                            <span class="recent-content" onclick="goToDate('${note.note_date}')">${(note.content || '').substring(0, 50)}${(note.content || '').length > 50 ? '...' : ''}</span>
                            ${note.tags && note.tags.length > 0 ? `<span class="recent-tags">${note.tags.map(t => `<span class="clickable-tag" onclick="filterByTag('${t}')">${t}</span>`).join(' ')}</span>` : ''}
                        </div>
                    `).join('');
                } else {
                    recentList.innerHTML = filterTag
                        ? '<p class="no-notes">í•´ë‹¹ íƒœê·¸ì˜ ë…¸íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.</p>'
                        : '<p class="no-notes">ì•„ì§ ë…¸íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                }
            } catch (err) {
                // ì¡°ìš©íˆ ì‹¤íŒ¨ (ìµœê·¼ ë…¸íŠ¸ ë¡œë“œ ì‹¤íŒ¨ëŠ” ì¹˜ëª…ì ì´ì§€ ì•ŠìŒ)
            }
        }

        // íƒœê·¸ë¡œ í•„í„°ë§
        window.filterByTag = function(tag) {
            currentFilterTag = tag;
            filterTagName.textContent = tag;
            filterTagEl.style.display = 'inline-flex';
            loadRecentNotes(tag);
        };

        // í•„í„° í•´ì œ
        window.clearTagFilter = function() {
            currentFilterTag = null;
            filterTagEl.style.display = 'none';
            loadRecentNotes();
        };

        window.goToDate = function(noteDate) {
            currentDate = noteDate;
            dateInput.value = noteDate;
            loadNote(noteDate);
            updateTodayBadge();
        };

        // ============ ë‚´ë³´ë‚´ê¸° ê¸°ëŠ¥ ============
        const exportStartDate = document.getElementById('exportStartDate');
        const exportEndDate = document.getElementById('exportEndDate');
        const exportCsvBtn = document.getElementById('exportCsv');
        const exportJsonBtn = document.getElementById('exportJson');

        // ê¸°ë³¸ê°’: ìµœê·¼ 30ì¼
        const today = new Date();
        const thirtyDaysAgo = new Date(today);
        thirtyDaysAgo.setDate(today.getDate() - 30);
        exportEndDate.value = today.toISOString().split('T')[0];
        exportStartDate.value = thirtyDaysAgo.toISOString().split('T')[0];

        // ë°ì´í„° ì¡°íšŒ
        async function fetchExportData() {
            if (!supabaseClient) {
                showStatus('Supabase ì—°ê²°ì´ í•„ìš”í•©ë‹ˆë‹¤.', 'error');
                return null;
            }

            const startDate = exportStartDate.value;
            const endDate = exportEndDate.value;

            if (!startDate || !endDate) {
                showStatus('ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.', 'error');
                return null;
            }

            try {
                const { data, error } = await supabaseClient
                    .from('daily_notes')
                    .select('*')
                    .gte('note_date', startDate)
                    .lte('note_date', endDate)
                    .order('note_date', { ascending: true });

                if (error) throw error;

                if (!data || data.length === 0) {
                    showStatus('í•´ë‹¹ ê¸°ê°„ì— ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.', 'error');
                    return null;
                }

                return data;
            } catch (err) {
                showStatus('ì¡°íšŒ ì‹¤íŒ¨: ' + err.message, 'error');
                return null;
            }
        }

        // CSV ë‚´ë³´ë‚´ê¸°
        exportCsvBtn.addEventListener('click', async () => {
            showStatus('ë°ì´í„° ì¡°íšŒ ì¤‘...', 'loading');
            const data = await fetchExportData();
            if (!data) return;

            // CSV í—¤ë”
            const headers = ['ë‚ ì§œ', 'ë©”ëª¨', 'íƒœê·¸', 'ì´ë¯¸ì§€URL'];
            const csvRows = [headers.join(',')];

            // CSV ë°ì´í„°
            data.forEach(note => {
                const row = [
                    note.note_date,
                    `"${(note.content || '').replace(/"/g, '""')}"`,
                    `"${(note.tags || []).join(', ')}"`,
                    `"${(note.image_urls || []).join(', ')}"`
                ];
                csvRows.push(row.join(','));
            });

            // BOM ì¶”ê°€ (ì—‘ì…€ì—ì„œ í•œê¸€ ê¹¨ì§ ë°©ì§€)
            const bom = '\uFEFF';
            const csvContent = bom + csvRows.join('\n');

            // ë‹¤ìš´ë¡œë“œ
            downloadFile(csvContent, `daily_notes_${exportStartDate.value}_${exportEndDate.value}.csv`, 'text/csv;charset=utf-8');
            showStatus(`${data.length}ê°œ ë…¸íŠ¸ CSV ë‚´ë³´ë‚´ê¸° ì™„ë£Œ!`, 'success');
        });

        // JSON ë‚´ë³´ë‚´ê¸°
        exportJsonBtn.addEventListener('click', async () => {
            showStatus('ë°ì´í„° ì¡°íšŒ ì¤‘...', 'loading');
            const data = await fetchExportData();
            if (!data) return;

            // í•„ìš”í•œ í•„ë“œë§Œ ì¶”ì¶œ
            const exportData = data.map(note => ({
                date: note.note_date,
                content: note.content,
                tags: note.tags,
                image_urls: note.image_urls
            }));

            const jsonContent = JSON.stringify(exportData, null, 2);

            // ë‹¤ìš´ë¡œë“œ
            downloadFile(jsonContent, `daily_notes_${exportStartDate.value}_${exportEndDate.value}.json`, 'application/json');
            showStatus(`${data.length}ê°œ ë…¸íŠ¸ JSON ë‚´ë³´ë‚´ê¸° ì™„ë£Œ!`, 'success');
        });

        // íŒŒì¼ ë‹¤ìš´ë¡œë“œ í—¬í¼
        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>
